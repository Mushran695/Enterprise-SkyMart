# CORS origin map: allow specific origins (dev + deployed host)
# Uses a regex for localhost dev ports and allows adding production domains.
map $http_origin $cors_origin {
  default "";
  "http://localhost:5173" $http_origin;
  "http://localhost:5174" $http_origin;
}

server {
    # ===== PREFLIGHT Handler (server-level) =====
    # OPTIONS requests return 204 with CORS headers if origin is allowed
    # If origin not in allowlist, $cors_origin is empty and no CORS headers sent
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With" always;
      add_header Vary "Origin" always;
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }

    # Explicit health endpoints mapping to service /health
    location = /api/auth/health {
      proxy_pass http://auth-service:3000/health;
      proxy_set_header Host $host;
      proxy_set_header Authorization $http_authorization;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
      if ($request_method = "OPTIONS") {
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
      }
    }

    location = /api/products/health {
      proxy_pass http://product-service:3001/health;
      proxy_set_header Host $host;
      proxy_set_header Authorization $http_authorization;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
      if ($request_method = "OPTIONS") {
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
      }
    }

    location = /api/orders/health {
      proxy_pass http://order-service:3002/health;
      proxy_set_header Host $host;
      proxy_set_header Authorization $http_authorization;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
      if ($request_method = "OPTIONS") {
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
      }
    }

    location = /api/cart/health {
      proxy_pass http://order-service:3002/health;
      proxy_set_header Host $host;
      proxy_set_header Authorization $http_authorization;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
      if ($request_method = "OPTIONS") {
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
      }
    }

    location = /api/payment/health {
      proxy_pass http://payment-service:3003/health;
      proxy_set_header Host $host;
      proxy_set_header Authorization $http_authorization;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
      if ($request_method = "OPTIONS") {
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
      }
    }

    location = /api/admin/health {
      proxy_pass http://admin-service:3005/health;
      proxy_set_header Host $host;
      proxy_set_header Authorization $http_authorization;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
      if ($request_method = "OPTIONS") {
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
      }
    }

    location = /api/admin/analytics/health {
      proxy_pass http://analytics-service:3004/health;
      proxy_set_header Host $host;
      proxy_set_header Authorization $http_authorization;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
      if ($request_method = "OPTIONS") {
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
      }
    }

    location = /api/analytics/health {
      proxy_pass http://analytics-service:3004/health;
      proxy_set_header Host $host;
      proxy_set_header Authorization $http_authorization;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
      if ($request_method = "OPTIONS") {
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
      }
    }

    location = /api/notification/health {
      proxy_pass http://notification-service:3010/health;
      proxy_set_header Host $host;
      proxy_set_header Authorization $http_authorization;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
      if ($request_method = "OPTIONS") {
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
      }
    }

  listen 80;
  server_name _;

  # Forward auth
  # Alias: singular/plural safe mappings
  location /api/product {
    # map /api/product/* -> product-service /api/products/*
    proxy_pass http://product-service:3001/api/products/;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    if ($request_method = "OPTIONS") { add_header Content-Length 0; add_header Content-Type text/plain; return 204; }
  }

  location /api/order {
    # map /api/order/* -> order-service /api/orders/*
    proxy_pass http://order-service:3002/api/orders/;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    if ($request_method = "OPTIONS") { add_header Content-Length 0; add_header Content-Type text/plain; return 204; }
  }

  location /api/notifications {
    proxy_pass http://notification-service:3010$request_uri;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    if ($request_method = "OPTIONS") { add_header Content-Length 0; add_header Content-Type text/plain; return 204; }
  }

  location /api/analysis {
    # alias /api/analysis/* -> analytics-service /api/analytics/*
    proxy_pass http://analytics-service:3004/api/analytics/;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    if ($request_method = "OPTIONS") { add_header Content-Length 0; add_header Content-Type text/plain; return 204; }
  }

  location /api/auth {
    proxy_pass http://auth-service:3000$request_uri;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # Ensure gateway is sole CORS authorizer
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    if ($request_method = "OPTIONS") {
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }
  }

  # Forward products
  location /api/products {
    proxy_pass http://product-service:3001$request_uri;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    if ($request_method = "OPTIONS") {
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }
  }

  # Orders
  location /api/orders {
    proxy_pass http://order-service:3002$request_uri;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    if ($request_method = "OPTIONS") {
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }
  }

  # Cart -> order-service
  location /api/cart {
    proxy_pass http://order-service:3002$request_uri;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    if ($request_method = "OPTIONS") {
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }
  }

  # Payment
  location /api/payment {
    proxy_pass http://payment-service:3003$request_uri;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    if ($request_method = "OPTIONS") {
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }
  }

  # Admin analytics -> analytics-service (keep heavy analytics here)
  location /api/admin/analytics {
    proxy_pass http://analytics-service:3004$request_uri;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    if ($request_method = "OPTIONS") {
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }
  }

  # Admin CRUD -> admin-service (users, products, orders-simple)
  location /api/admin {
    proxy_pass http://admin-service:3005$request_uri;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    if ($request_method = "OPTIONS") {
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }
  }

  # Analytics -> analytics-service (non-admin analytics paths)
  location /api/analytics {
    proxy_pass http://analytics-service:3004$request_uri;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    if ($request_method = "OPTIONS") {
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }
  }

  # Fallback for health
  # Notification service (optional)
  location /api/notification {
    proxy_pass http://notification-service:3010$request_uri;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    if ($request_method = "OPTIONS") {
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }
  }

  location / {
    return 200 'OK';
  }
}
